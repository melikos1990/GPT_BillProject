<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>電費分攤（手動讀表 + 自動扣上次）</title>

  <style>
    body { font-family: sans-serif; margin: 16px; line-height: 1.5; }
    h1 { font-size: 22px; margin: 8px 0 10px; }
    .hint { font-size: 14px; color:#444; margin-bottom: 12px; }
    .row { display:flex; flex-wrap: wrap; gap: 10px; align-items: end; margin: 10px 0; }
    .field { display:flex; flex-direction: column; gap: 6px; }
    label { font-size: 14px; color:#222; }

    input[type="number"], input[type="text"]{
      font-size: 16px; padding: 10px 10px; box-sizing:border-box;
      border: 1px solid #ccc; border-radius: 10px; min-width: 160px;
    }

    button{
      font-size: 16px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #ccc; background: #fff; cursor:pointer;
    }
    button.primary { background:#1f6feb; border-color:#1f6feb; color:#fff; }
    button.danger { background:#d73a49; border-color:#d73a49; color:#fff; }
    button.small { font-size: 14px; padding: 8px 10px; border-radius: 10px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; border:1px solid #eee; border-radius: 12px; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { border-bottom:1px solid #eee; padding: 10px; text-align: center; white-space: nowrap; vertical-align: middle; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 1; }

    .muted { color:#666; font-size: 13px; }
    .strong { font-weight: 700; }

    @media (max-width: 600px){
      body { margin: 12px; }
      input[type="number"], input[type="text"] { min-width: 0; width: 100%; }
      button { width: 100%; padding: 12px; }
      .field { width: 100%; }
      table { min-width: 980px; } /* 手機用橫滑 */
    }
  </style>
</head>

<body>
  <h1>電費分攤（手動讀表 + 自動扣上次）</h1>
  <div class="hint">
    ✅ 你只要輸入<strong>總電費</strong>，每房手動填入<strong>本期讀數</strong>。<br>
    ✅ 系統會用：<span class="strong">本期讀數 - 上次本期讀數 = 本次用電</span>（上次本期讀數存於本機瀏覽器）。<br>
    ✅ 按「保存本次讀數」後，本次本期會變成下次的上次本期。
  </div>

  <div class="row">
    <div class="field">
      <label>總電費 (元)</label>
      <input type="number" id="totalBill" min="0" step="0.01" value="0" />
    </div>

    <div class="field" style="flex:1; min-width: 240px;">
      <label class="muted">快捷</label>
      <div class="row" style="margin:0; gap:8px;">
        <button class="primary" type="button" id="btnAdd">新增房間（2A/2B…）</button>
        <button type="button" id="btnCalc">重新計算</button>
        <button class="danger" type="button" id="btnClearAll">清空全部紀錄（含上次讀數）</button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>房號</th>
          <th>上次本期讀數<br><span class="muted">(自動帶入)</span></th>
          <th>本期讀數<br><span class="muted">(手動填)</span></th>
          <th>本次用電</th>
          <th>電費分攤</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="roomsBody"></tbody>
    </table>
  </div>

<script>
  // 本機儲存：每房一筆「上次本期讀數」
  function roomKey(roomId) { return `lastReading_${roomId}`; }

  function getLastReading(roomId) {
    const raw = localStorage.getItem(roomKey(roomId));
    const n = raw == null ? 0 : parseFloat(raw);
    return Number.isFinite(n) ? n : 0;
  }

  function setLastReading(roomId, val) {
    localStorage.setItem(roomKey(roomId), String(val));
  }

  function nextRoomIdSuggestion() {
    const existing = new Set(
      Array.from(document.querySelectorAll(".roomId"))
        .map(i => (i.value || "").trim().toUpperCase())
        .filter(Boolean)
    );
    const base = "2";
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    for (const ch of letters) {
      const candidate = base + ch; // 2A,2B...
      if (!existing.has(candidate)) return candidate;
    }
    return "2Z";
  }

  function normalizeRoomId(tr) {
    const inp = tr.querySelector(".roomId");
    const id = (inp.value || "").trim().toUpperCase();
    inp.value = id;
    return id;
  }

  function updateLastReadingCell(tr) {
    const id = normalizeRoomId(tr);
    const cell = tr.querySelector(".last");
    if (!id) { cell.textContent = "-"; return; }
    cell.textContent = getLastReading(id).toFixed(2);
  }

  function addRoom(prefillId) {
    const tbody = document.getElementById("roomsBody");
    const tr = document.createElement("tr");
    const roomId = (prefillId || nextRoomIdSuggestion()).toUpperCase();

    tr.innerHTML = `
      <td>
        <input type="text" class="roomId" value="${roomId}" placeholder="例：2A"
               style="width:90px; text-align:center;" />
      </td>
      <td class="last strong">0.00</td>
      <td><input type="number" class="curr" min="0" step="0.01" value="0" /></td>
      <td class="usage strong">0.00</td>
      <td class="share">-</td>
      <td>
        <button type="button" class="primary small saveBtn">保存本次讀數</button>
        <button type="button" class="danger small delBtn">刪除</button>
      </td>
    `;

    tbody.appendChild(tr);

    tr.querySelector(".roomId").addEventListener("change", () => {
      updateLastReadingCell(tr);
      calculate();
    });

    tr.querySelector(".curr").addEventListener("input", () => calculate());

    tr.querySelector(".saveBtn").addEventListener("click", () => {
      const id = normalizeRoomId(tr);
      if (!id) { alert("請先填房號（例：2A）"); return; }

      const curr = parseFloat(tr.querySelector(".curr").value);
      if (!Number.isFinite(curr)) { alert("本期讀數不正確"); return; }

      setLastReading(id, curr);
      updateLastReadingCell(tr);
      calculate();
      alert(`已保存 ${id} 本次讀數：${curr.toFixed(2)}（下次會自動扣這個值）`);
    });

    tr.querySelector(".delBtn").addEventListener("click", () => {
      tr.remove();
      calculate();
    });

    updateLastReadingCell(tr);
    calculate();
  }

  function calculate() {
    const totalBillValue = parseFloat(document.getElementById("totalBill").value) || 0;
    const rows = Array.from(document.querySelectorAll("#roomsBody tr"));

    const usages = rows.map(tr => {
      const id = (tr.querySelector(".roomId").value || "").trim().toUpperCase();
      const last = id ? getLastReading(id) : 0;
      const curr = parseFloat(tr.querySelector(".curr").value) || 0;
      return Math.max(curr - last, 0);
    });

    const totalUsage = usages.reduce((s, v) => s + v, 0);

    rows.forEach((tr, idx) => {
      const usage = usages[idx];
      tr.querySelector(".usage").textContent = usage.toFixed(2);

      let share = 0;
      if (totalUsage > 0) share = (usage / totalUsage) * totalBillValue;

      tr.querySelector(".share").textContent = share.toFixed(2) + " 元";
    });
  }

  function clearAll() {
    if (!confirm("確定要清空全部紀錄？（會刪除所有房間的『上次本期讀數』）")) return;

    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith("lastReading_")) keys.push(k);
    }
    keys.forEach(k => localStorage.removeItem(k));

    document.getElementById("roomsBody").innerHTML = "";
    document.getElementById("totalBill").value = "0";
  }

  document.getElementById("btnAdd").addEventListener("click", () => addRoom());
  document.getElementById("btnCalc").addEventListener("click", calculate);
  document.getElementById("btnClearAll").addEventListener("click", clearAll);
  document.getElementById("totalBill").addEventListener("input", calculate);

  window.addEventListener("load", () => {
    addRoom("2A");
    addRoom("2B");
  });
</script>
</body>
</html>
